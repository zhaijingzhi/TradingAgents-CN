{% extends "base.html" %}

{% block title %}åˆ†æå†å² - TradingAgents-CN{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-history me-2"></i>
            åˆ†æå†å²
        </h1>
    </div>
</div>

<!-- ç­›é€‰å™¨ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-filter me-2"></i>
                ç­›é€‰æ¡ä»¶
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label for="date-range" class="form-label">æ—¥æœŸèŒƒå›´</label>
                        <select class="form-select" id="date-range">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="today">ä»Šå¤©</option>
                            <option value="week">æœ€è¿‘ä¸€å‘¨</option>
                            <option value="month" selected>æœ€è¿‘ä¸€æœˆ</option>
                            <option value="quarter">æœ€è¿‘ä¸‰æœˆ</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="status-filter" class="form-label">åˆ†æçŠ¶æ€</label>
                        <select class="form-select" id="status-filter">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="completed">å·²å®Œæˆ</option>
                            <option value="failed">å¤±è´¥</option>
                            <option value="running">è¿›è¡Œä¸­</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="recommendation-filter" class="form-label">æŠ•èµ„å»ºè®®</label>
                        <select class="form-select" id="recommendation-filter">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="BUY">ä¹°å…¥</option>
                            <option value="HOLD">æŒæœ‰</option>
                            <option value="SELL">å–å‡º</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="search-symbol" class="form-label">è‚¡ç¥¨ä»£ç </label>
                        <input type="text" class="form-control" id="search-symbol" 
                               placeholder="æœç´¢è‚¡ç¥¨ä»£ç ">
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <button class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-search me-2"></i>
                            åº”ç”¨ç­›é€‰
                        </button>
                        <button class="btn btn-outline-secondary ms-2" onclick="resetFilters()">
                            <i class="fas fa-undo me-2"></i>
                            é‡ç½®
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç»Ÿè®¡æ¦‚è§ˆ -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-chart-line fa-2x text-primary mb-2"></i>
                <h5 class="card-title">æ€»åˆ†ææ¬¡æ•°</h5>
                <h4 class="text-primary" id="total-analyses">0</h4>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                <h5 class="card-title">æˆåŠŸåˆ†æ</h5>
                <h4 class="text-success" id="completed-analyses">0</h4>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-times-circle fa-2x text-danger mb-2"></i>
                <h5 class="card-title">å¤±è´¥åˆ†æ</h5>
                <h4 class="text-danger" id="failed-analyses">0</h4>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-spinner fa-2x text-warning mb-2"></i>
                <h5 class="card-title">è¿›è¡Œä¸­</h5>
                <h4 class="text-warning" id="running-analyses">0</h4>
            </div>
        </div>
    </div>
</div>

<!-- å†å²è®°å½•åˆ—è¡¨ -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="fas fa-list me-2"></i>
                    åˆ†æè®°å½•
                </span>
                <button class="btn btn-outline-primary btn-sm" onclick="refreshHistory()">
                    <i class="fas fa-sync-alt me-1"></i>
                    åˆ·æ–°
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>æ—¶é—´</th>
                                <th>è‚¡ç¥¨ä»£ç </th>
                                <th>çŠ¶æ€</th>
                                <th>æŠ•èµ„å»ºè®®</th>
                                <th>ç½®ä¿¡åº¦</th>
                                <th>é£é™©è¯„åˆ†</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="history-tbody">
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                    </div>
                                    <p class="mt-2">æ­£åœ¨åŠ è½½å†å²è®°å½•...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- åˆ†é¡µ -->
                <nav id="pagination-nav" style="display: none;">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- åˆ†é¡µæŒ‰é’®å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- åˆ†æè¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="analysisDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-area me-2"></i>
                    åˆ†æè¯¦æƒ…
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="analysis-detail-content">
                <!-- è¯¦æƒ…å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" onclick="exportAnalysis()">
                    <i class="fas fa-download me-2"></i>
                    å¯¼å‡ºæŠ¥å‘Š
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let historyData = [];
    let filteredData = [];
    let currentPage = 1;
    let pageSize = 10;
    let selectedAnalysisId = null;
    
    // é¡µé¢åŠ è½½æ—¶è·å–å†å²æ•°æ®
    document.addEventListener('DOMContentLoaded', function() {
        loadHistoryData();
    });
    
    function loadHistoryData() {
        fetch('/api/history')
            .then(response => response.json())
            .then(data => {
                historyData = data.history;
                filteredData = historyData;
                updateStatistics();
                updateHistoryTable();
            })
            .catch(error => {
                console.error('åŠ è½½å†å²æ•°æ®å¤±è´¥:', error);
                showError('åŠ è½½å†å²æ•°æ®å¤±è´¥');
            });
    }
    
    function updateStatistics() {
        const total = historyData.length;
        const completed = historyData.filter(item => item.status === 'completed').length;
        const failed = historyData.filter(item => item.status === 'failed').length;
        const running = historyData.filter(item => item.status === 'running').length;
        
        document.getElementById('total-analyses').textContent = total;
        document.getElementById('completed-analyses').textContent = completed;
        document.getElementById('failed-analyses').textContent = failed;
        document.getElementById('running-analyses').textContent = running;
    }
    
    function updateHistoryTable() {
        const tbody = document.getElementById('history-tbody');
        
        if (filteredData.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>æš‚æ— åˆ†æè®°å½•</p>
                        <a href="/stock-analysis" class="btn btn-primary">
                            å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡åˆ†æ
                        </a>
                    </td>
                </tr>
            `;
            document.getElementById('pagination-nav').style.display = 'none';
            return;
        }
        
        // åˆ†é¡µå¤„ç†
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const pageData = filteredData.slice(startIndex, endIndex);
        
        tbody.innerHTML = pageData.map(item => {
            const statusBadge = getStatusBadge(item.status);
            const recommendationBadge = getRecommendationBadge(item.recommendation);
            const confidence = item.confidence ? `${(item.confidence * 100).toFixed(1)}%` : 'N/A';
            const riskScore = item.risk_score ? `${(item.risk_score * 100).toFixed(1)}%` : 'N/A';
            
            return `
                <tr>
                    <td>${formatDateTime(item.created_at)}</td>
                    <td><strong>${item.stock_symbol || 'N/A'}</strong></td>
                    <td>${statusBadge}</td>
                    <td>${recommendationBadge}</td>
                    <td>${confidence}</td>
                    <td>${riskScore}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewAnalysisDetail('${item.id}')" 
                                    title="æŸ¥çœ‹è¯¦æƒ…">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${item.status === 'completed' ? `
                                <button class="btn btn-outline-success" onclick="exportAnalysisReport('${item.id}')" 
                                        title="å¯¼å‡ºæŠ¥å‘Š">
                                    <i class="fas fa-download"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        // æ›´æ–°åˆ†é¡µ
        updatePagination();
    }
    
    function getStatusBadge(status) {
        const badges = {
            'completed': '<span class="badge bg-success">å·²å®Œæˆ</span>',
            'failed': '<span class="badge bg-danger">å¤±è´¥</span>',
            'running': '<span class="badge bg-warning">è¿›è¡Œä¸­</span>'
        };
        return badges[status] || '<span class="badge bg-secondary">æœªçŸ¥</span>';
    }
    
    function getRecommendationBadge(recommendation) {
        if (!recommendation || recommendation === 'N/A') {
            return '<span class="text-muted">N/A</span>';
        }
        
        const badges = {
            'BUY': '<span class="badge bg-success">ä¹°å…¥</span>',
            'SELL': '<span class="badge bg-danger">å–å‡º</span>',
            'HOLD': '<span class="badge bg-warning">æŒæœ‰</span>'
        };
        return badges[recommendation] || `<span class="badge bg-secondary">${recommendation}</span>`;
    }
    
    function formatDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    
    function updatePagination() {
        const totalPages = Math.ceil(filteredData.length / pageSize);
        const paginationNav = document.getElementById('pagination-nav');
        const pagination = document.getElementById('pagination');
        
        if (totalPages <= 1) {
            paginationNav.style.display = 'none';
            return;
        }
        
        paginationNav.style.display = 'block';
        
        let paginationHTML = '';
        
        // ä¸Šä¸€é¡µ
        paginationHTML += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">ä¸Šä¸€é¡µ</a>
            </li>
        `;
        
        // é¡µç 
        for (let i = 1; i <= totalPages; i++) {
            if (i === currentPage || i === 1 || i === totalPages || 
                (i >= currentPage - 1 && i <= currentPage + 1)) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
            } else if (i === currentPage - 2 || i === currentPage + 2) {
                paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
        }
        
        // ä¸‹ä¸€é¡µ
        paginationHTML += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">ä¸‹ä¸€é¡µ</a>
            </li>
        `;
        
        pagination.innerHTML = paginationHTML;
    }
    
    function changePage(page) {
        const totalPages = Math.ceil(filteredData.length / pageSize);
        if (page < 1 || page > totalPages) return;
        
        currentPage = page;
        updateHistoryTable();
    }
    
    function applyFilters() {
        const dateRange = document.getElementById('date-range').value;
        const statusFilter = document.getElementById('status-filter').value;
        const recommendationFilter = document.getElementById('recommendation-filter').value;
        const searchSymbol = document.getElementById('search-symbol').value.trim().toUpperCase();
        
        filteredData = historyData.filter(item => {
            // æ—¥æœŸç­›é€‰
            if (dateRange !== 'all') {
                const itemDate = new Date(item.created_at);
                const now = new Date();
                const diffDays = (now - itemDate) / (1000 * 60 * 60 * 24);
                
                switch (dateRange) {
                    case 'today':
                        if (diffDays > 1) return false;
                        break;
                    case 'week':
                        if (diffDays > 7) return false;
                        break;
                    case 'month':
                        if (diffDays > 30) return false;
                        break;
                    case 'quarter':
                        if (diffDays > 90) return false;
                        break;
                }
            }
            
            // çŠ¶æ€ç­›é€‰
            if (statusFilter !== 'all' && item.status !== statusFilter) {
                return false;
            }
            
            // æŠ•èµ„å»ºè®®ç­›é€‰
            if (recommendationFilter !== 'all' && item.recommendation !== recommendationFilter) {
                return false;
            }
            
            // è‚¡ç¥¨ä»£ç æœç´¢
            if (searchSymbol && (!item.stock_symbol || !item.stock_symbol.includes(searchSymbol))) {
                return false;
            }
            
            return true;
        });
        
        currentPage = 1;
        updateHistoryTable();
    }
    
    function resetFilters() {
        document.getElementById('date-range').value = 'month';
        document.getElementById('status-filter').value = 'all';
        document.getElementById('recommendation-filter').value = 'all';
        document.getElementById('search-symbol').value = '';
        
        filteredData = historyData;
        currentPage = 1;
        updateHistoryTable();
    }
    
    function refreshHistory() {
        loadHistoryData();
    }
    
    function viewAnalysisDetail(analysisId) {
        selectedAnalysisId = analysisId;
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        document.getElementById('analysis-detail-content').innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                </div>
                <p class="mt-2">æ­£åœ¨åŠ è½½åˆ†æè¯¦æƒ…...</p>
            </div>
        `;
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        const modal = new bootstrap.Modal(document.getElementById('analysisDetailModal'));
        modal.show();
        
        // è·å–è¯¦æƒ…æ•°æ®
        fetch(`/api/progress/${analysisId}`)
            .then(response => response.json())
            .then(data => {
                displayAnalysisDetail(data);
            })
            .catch(error => {
                document.getElementById('analysis-detail-content').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        åŠ è½½åˆ†æè¯¦æƒ…å¤±è´¥: ${error.message}
                    </div>
                `;
            });
    }
    
    function displayAnalysisDetail(data) {
        const content = document.getElementById('analysis-detail-content');
        
        if (data.status === 'completed' && data.result) {
            const result = data.result;
            const decision = result.decision;
            
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>ğŸ“Š åŸºæœ¬ä¿¡æ¯</h6>
                        <table class="table table-sm">
                            <tr><td>è‚¡ç¥¨ä»£ç :</td><td><strong>${result.stock_symbol}</strong></td></tr>
                            <tr><td>åˆ†ææ—¥æœŸ:</td><td>${result.analysis_date}</td></tr>
                            <tr><td>åˆ†æID:</td><td><code>${data.analysis_id}</code></td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>ğŸ¯ æŠ•èµ„å»ºè®®</h6>
                        <table class="table table-sm">
                            <tr><td>æ¨èæ“ä½œ:</td><td>${getRecommendationBadge(decision.action)}</td></tr>
                            <tr><td>ç½®ä¿¡åº¦:</td><td>${(decision.confidence * 100).toFixed(1)}%</td></tr>
                            <tr><td>é£é™©è¯„åˆ†:</td><td>${(decision.risk_score * 100).toFixed(1)}%</td></tr>
                        </table>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6>ğŸ’­ åˆ†ææ¨ç†</h6>
                    <div class="bg-light p-3 rounded">
                        <pre style="white-space: pre-wrap; font-family: inherit;">${decision.reasoning || 'æš‚æ— è¯¦ç»†æ¨ç†ä¿¡æ¯'}</pre>
                    </div>
                </div>
            `;
        } else if (data.status === 'failed') {
            content.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-times-circle me-2"></i>åˆ†æå¤±è´¥</h6>
                    <p><strong>é”™è¯¯ä¿¡æ¯:</strong> ${data.error || 'æœªçŸ¥é”™è¯¯'}</p>
                    <p><strong>åˆ†æID:</strong> <code>${data.analysis_id}</code></p>
                </div>
            `;
        } else {
            content.innerHTML = `
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>åˆ†æçŠ¶æ€</h6>
                    <p><strong>å½“å‰çŠ¶æ€:</strong> ${getStatusBadge(data.status)}</p>
                    <p><strong>è¿›åº¦:</strong> ${data.progress}%</p>
                    <p><strong>æ¶ˆæ¯:</strong> ${data.message}</p>
                </div>
            `;
        }
    }
    
    function exportAnalysisReport(analysisId) {
        window.open(`/api/export/${analysisId}`, '_blank');
    }
    
    function exportAnalysis() {
        if (selectedAnalysisId) {
            exportAnalysisReport(selectedAnalysisId);
        }
    }
    
    function showError(message) {
        const tbody = document.getElementById('history-tbody');
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="loadHistoryData()">
                        é‡æ–°åŠ è½½
                    </button>
                </td>
            </tr>
        `;
    }
</script>
{% endblock %}