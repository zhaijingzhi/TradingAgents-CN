{% extends "base.html" %}

{% block title %}分析历史 - TradingAgents-CN{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-history me-2"></i>
            分析历史
        </h1>
    </div>
</div>

<!-- 筛选器 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-filter me-2"></i>
                筛选条件
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label for="date-range" class="form-label">日期范围</label>
                        <select class="form-select" id="date-range">
                            <option value="all">全部</option>
                            <option value="today">今天</option>
                            <option value="week">最近一周</option>
                            <option value="month" selected>最近一月</option>
                            <option value="quarter">最近三月</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="status-filter" class="form-label">分析状态</label>
                        <select class="form-select" id="status-filter">
                            <option value="all">全部</option>
                            <option value="completed">已完成</option>
                            <option value="failed">失败</option>
                            <option value="running">进行中</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="recommendation-filter" class="form-label">投资建议</label>
                        <select class="form-select" id="recommendation-filter">
                            <option value="all">全部</option>
                            <option value="BUY">买入</option>
                            <option value="HOLD">持有</option>
                            <option value="SELL">卖出</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="search-symbol" class="form-label">股票代码</label>
                        <input type="text" class="form-control" id="search-symbol" 
                               placeholder="搜索股票代码">
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <button class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-search me-2"></i>
                            应用筛选
                        </button>
                        <button class="btn btn-outline-secondary ms-2" onclick="resetFilters()">
                            <i class="fas fa-undo me-2"></i>
                            重置
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 统计概览 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-chart-line fa-2x text-primary mb-2"></i>
                <h5 class="card-title">总分析次数</h5>
                <h4 class="text-primary" id="total-analyses">0</h4>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                <h5 class="card-title">成功分析</h5>
                <h4 class="text-success" id="completed-analyses">0</h4>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-times-circle fa-2x text-danger mb-2"></i>
                <h5 class="card-title">失败分析</h5>
                <h4 class="text-danger" id="failed-analyses">0</h4>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-spinner fa-2x text-warning mb-2"></i>
                <h5 class="card-title">进行中</h5>
                <h4 class="text-warning" id="running-analyses">0</h4>
            </div>
        </div>
    </div>
</div>

<!-- 历史记录列表 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="fas fa-list me-2"></i>
                    分析记录
                </span>
                <button class="btn btn-outline-primary btn-sm" onclick="refreshHistory()">
                    <i class="fas fa-sync-alt me-1"></i>
                    刷新
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>股票代码</th>
                                <th>状态</th>
                                <th>投资建议</th>
                                <th>置信度</th>
                                <th>风险评分</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="history-tbody">
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                    <p class="mt-2">正在加载历史记录...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页 -->
                <nav id="pagination-nav" style="display: none;">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- 分页按钮将在这里生成 -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- 分析详情模态框 -->
<div class="modal fade" id="analysisDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-area me-2"></i>
                    分析详情
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="analysis-detail-content">
                <!-- 详情内容将在这里显示 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" onclick="exportAnalysis()">
                    <i class="fas fa-download me-2"></i>
                    导出报告
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let historyData = [];
    let filteredData = [];
    let currentPage = 1;
    let pageSize = 10;
    let selectedAnalysisId = null;
    
    // 页面加载时获取历史数据
    document.addEventListener('DOMContentLoaded', function() {
        loadHistoryData();
    });
    
    function loadHistoryData() {
        fetch('/api/history')
            .then(response => response.json())
            .then(data => {
                historyData = data.history;
                filteredData = historyData;
                updateStatistics();
                updateHistoryTable();
            })
            .catch(error => {
                console.error('加载历史数据失败:', error);
                showError('加载历史数据失败');
            });
    }
    
    function updateStatistics() {
        const total = historyData.length;
        const completed = historyData.filter(item => item.status === 'completed').length;
        const failed = historyData.filter(item => item.status === 'failed').length;
        const running = historyData.filter(item => item.status === 'running').length;
        
        document.getElementById('total-analyses').textContent = total;
        document.getElementById('completed-analyses').textContent = completed;
        document.getElementById('failed-analyses').textContent = failed;
        document.getElementById('running-analyses').textContent = running;
    }
    
    function updateHistoryTable() {
        const tbody = document.getElementById('history-tbody');
        
        if (filteredData.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>暂无分析记录</p>
                        <a href="/stock-analysis" class="btn btn-primary">
                            开始您的第一次分析
                        </a>
                    </td>
                </tr>
            `;
            document.getElementById('pagination-nav').style.display = 'none';
            return;
        }
        
        // 分页处理
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const pageData = filteredData.slice(startIndex, endIndex);
        
        tbody.innerHTML = pageData.map(item => {
            const statusBadge = getStatusBadge(item.status);
            const recommendationBadge = getRecommendationBadge(item.recommendation);
            const confidence = item.confidence ? `${(item.confidence * 100).toFixed(1)}%` : 'N/A';
            const riskScore = item.risk_score ? `${(item.risk_score * 100).toFixed(1)}%` : 'N/A';
            
            return `
                <tr>
                    <td>${formatDateTime(item.created_at)}</td>
                    <td><strong>${item.stock_symbol || 'N/A'}</strong></td>
                    <td>${statusBadge}</td>
                    <td>${recommendationBadge}</td>
                    <td>${confidence}</td>
                    <td>${riskScore}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewAnalysisDetail('${item.id}')" 
                                    title="查看详情">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${item.status === 'completed' ? `
                                <button class="btn btn-outline-success" onclick="exportAnalysisReport('${item.id}')" 
                                        title="导出报告">
                                    <i class="fas fa-download"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        // 更新分页
        updatePagination();
    }
    
    function getStatusBadge(status) {
        const badges = {
            'completed': '<span class="badge bg-success">已完成</span>',
            'failed': '<span class="badge bg-danger">失败</span>',
            'running': '<span class="badge bg-warning">进行中</span>'
        };
        return badges[status] || '<span class="badge bg-secondary">未知</span>';
    }
    
    function getRecommendationBadge(recommendation) {
        if (!recommendation || recommendation === 'N/A') {
            return '<span class="text-muted">N/A</span>';
        }
        
        const badges = {
            'BUY': '<span class="badge bg-success">买入</span>',
            'SELL': '<span class="badge bg-danger">卖出</span>',
            'HOLD': '<span class="badge bg-warning">持有</span>'
        };
        return badges[recommendation] || `<span class="badge bg-secondary">${recommendation}</span>`;
    }
    
    function formatDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    
    function updatePagination() {
        const totalPages = Math.ceil(filteredData.length / pageSize);
        const paginationNav = document.getElementById('pagination-nav');
        const pagination = document.getElementById('pagination');
        
        if (totalPages <= 1) {
            paginationNav.style.display = 'none';
            return;
        }
        
        paginationNav.style.display = 'block';
        
        let paginationHTML = '';
        
        // 上一页
        paginationHTML += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">上一页</a>
            </li>
        `;
        
        // 页码
        for (let i = 1; i <= totalPages; i++) {
            if (i === currentPage || i === 1 || i === totalPages || 
                (i >= currentPage - 1 && i <= currentPage + 1)) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
            } else if (i === currentPage - 2 || i === currentPage + 2) {
                paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
        }
        
        // 下一页
        paginationHTML += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">下一页</a>
            </li>
        `;
        
        pagination.innerHTML = paginationHTML;
    }
    
    function changePage(page) {
        const totalPages = Math.ceil(filteredData.length / pageSize);
        if (page < 1 || page > totalPages) return;
        
        currentPage = page;
        updateHistoryTable();
    }
    
    function applyFilters() {
        const dateRange = document.getElementById('date-range').value;
        const statusFilter = document.getElementById('status-filter').value;
        const recommendationFilter = document.getElementById('recommendation-filter').value;
        const searchSymbol = document.getElementById('search-symbol').value.trim().toUpperCase();
        
        filteredData = historyData.filter(item => {
            // 日期筛选
            if (dateRange !== 'all') {
                const itemDate = new Date(item.created_at);
                const now = new Date();
                const diffDays = (now - itemDate) / (1000 * 60 * 60 * 24);
                
                switch (dateRange) {
                    case 'today':
                        if (diffDays > 1) return false;
                        break;
                    case 'week':
                        if (diffDays > 7) return false;
                        break;
                    case 'month':
                        if (diffDays > 30) return false;
                        break;
                    case 'quarter':
                        if (diffDays > 90) return false;
                        break;
                }
            }
            
            // 状态筛选
            if (statusFilter !== 'all' && item.status !== statusFilter) {
                return false;
            }
            
            // 投资建议筛选
            if (recommendationFilter !== 'all' && item.recommendation !== recommendationFilter) {
                return false;
            }
            
            // 股票代码搜索
            if (searchSymbol && (!item.stock_symbol || !item.stock_symbol.includes(searchSymbol))) {
                return false;
            }
            
            return true;
        });
        
        currentPage = 1;
        updateHistoryTable();
    }
    
    function resetFilters() {
        document.getElementById('date-range').value = 'month';
        document.getElementById('status-filter').value = 'all';
        document.getElementById('recommendation-filter').value = 'all';
        document.getElementById('search-symbol').value = '';
        
        filteredData = historyData;
        currentPage = 1;
        updateHistoryTable();
    }
    
    function refreshHistory() {
        loadHistoryData();
    }
    
    function viewAnalysisDetail(analysisId) {
        selectedAnalysisId = analysisId;
        
        // 显示加载状态
        document.getElementById('analysis-detail-content').innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2">正在加载分析详情...</p>
            </div>
        `;
        
        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('analysisDetailModal'));
        modal.show();
        
        // 获取详情数据
        fetch(`/api/progress/${analysisId}`)
            .then(response => response.json())
            .then(data => {
                displayAnalysisDetail(data);
            })
            .catch(error => {
                document.getElementById('analysis-detail-content').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        加载分析详情失败: ${error.message}
                    </div>
                `;
            });
    }
    
    function displayAnalysisDetail(data) {
        const content = document.getElementById('analysis-detail-content');
        
        if (data.status === 'completed' && data.result) {
            const result = data.result;
            const decision = result.decision;
            
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>📊 基本信息</h6>
                        <table class="table table-sm">
                            <tr><td>股票代码:</td><td><strong>${result.stock_symbol}</strong></td></tr>
                            <tr><td>分析日期:</td><td>${result.analysis_date}</td></tr>
                            <tr><td>分析ID:</td><td><code>${data.analysis_id}</code></td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>🎯 投资建议</h6>
                        <table class="table table-sm">
                            <tr><td>推荐操作:</td><td>${getRecommendationBadge(decision.action)}</td></tr>
                            <tr><td>置信度:</td><td>${(decision.confidence * 100).toFixed(1)}%</td></tr>
                            <tr><td>风险评分:</td><td>${(decision.risk_score * 100).toFixed(1)}%</td></tr>
                        </table>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6>💭 分析推理</h6>
                    <div class="bg-light p-3 rounded">
                        <pre style="white-space: pre-wrap; font-family: inherit;">${decision.reasoning || '暂无详细推理信息'}</pre>
                    </div>
                </div>
            `;
        } else if (data.status === 'failed') {
            content.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-times-circle me-2"></i>分析失败</h6>
                    <p><strong>错误信息:</strong> ${data.error || '未知错误'}</p>
                    <p><strong>分析ID:</strong> <code>${data.analysis_id}</code></p>
                </div>
            `;
        } else {
            content.innerHTML = `
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>分析状态</h6>
                    <p><strong>当前状态:</strong> ${getStatusBadge(data.status)}</p>
                    <p><strong>进度:</strong> ${data.progress}%</p>
                    <p><strong>消息:</strong> ${data.message}</p>
                </div>
            `;
        }
    }
    
    function exportAnalysisReport(analysisId) {
        window.open(`/api/export/${analysisId}`, '_blank');
    }
    
    function exportAnalysis() {
        if (selectedAnalysisId) {
            exportAnalysisReport(selectedAnalysisId);
        }
    }
    
    function showError(message) {
        const tbody = document.getElementById('history-tbody');
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="loadHistoryData()">
                        重新加载
                    </button>
                </td>
            </tr>
        `;
    }
</script>
{% endblock %}