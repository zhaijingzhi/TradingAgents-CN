{% extends "base.html" %}

{% block title %}Á≥ªÁªüËÆæÁΩÆ - TradingAgents-CN{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-cog me-2"></i>
            Á≥ªÁªüËÆæÁΩÆ
        </h1>
    </div>
</div>

<!-- ËÆæÁΩÆÈÄâÈ°πÂç° -->
<div class="row">
    <div class="col-12">
        <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="api-tab" data-bs-toggle="tab" 
                        data-bs-target="#api-settings" type="button" role="tab">
                    <i class="fas fa-key me-2"></i>
                    APIÈÖçÁΩÆ
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="model-tab" data-bs-toggle="tab" 
                        data-bs-target="#model-settings" type="button" role="tab">
                    <i class="fas fa-robot me-2"></i>
                    Ê®°ÂûãËÆæÁΩÆ
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="system-tab" data-bs-toggle="tab" 
                        data-bs-target="#system-settings" type="button" role="tab">
                    <i class="fas fa-server me-2"></i>
                    Á≥ªÁªü‰ø°ÊÅØ
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="settingsTabContent">
            <!-- APIÈÖçÁΩÆÈÄâÈ°πÂç° -->
            <div class="tab-pane fade show active" id="api-settings" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <i class="fas fa-key me-2"></i>
                        APIÂØÜÈí•ÈÖçÁΩÆ
                    </div>
                    <div class="card-body">
                        <form id="api-settings-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary mb-3">üá®üá≥ ÂõΩ‰∫ßAIÊ®°Âûã</h6>
                                    
                                    <div class="mb-3">
                                        <label for="dashscope-key" class="form-label">
                                            ÈòøÈáåÁôæÁÇº API Key
                                            <span id="dashscope-status" class="ms-2"></span>
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="dashscope-key" 
                                                   placeholder="sk-xxxxxxxxxxxxxxxx">
                                            <button class="btn btn-outline-secondary" type="button" 
                                                    onclick="togglePassword('dashscope-key')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">
                                            ‰ªé <a href="https://dashscope.aliyun.com/" target="_blank">ÈòøÈáåÁôæÁÇºÊéßÂà∂Âè∞</a> Ëé∑Âèñ
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="deepseek-key" class="form-label">
                                            DeepSeek API Key
                                            <span id="deepseek-status" class="ms-2"></span>
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="deepseek-key" 
                                                   placeholder="sk-xxxxxxxxxxxxxxxx">
                                            <button class="btn btn-outline-secondary" type="button" 
                                                    onclick="togglePassword('deepseek-key')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">
                                            ‰ªé <a href="https://platform.deepseek.com/" target="_blank">DeepSeekÂπ≥Âè∞</a> Ëé∑Âèñ
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6 class="text-info mb-3">üåç ÂõΩÈôÖAIÊ®°Âûã</h6>
                                    
                                    <div class="mb-3">
                                        <label for="google-key" class="form-label">
                                            Google AI API Key
                                            <span id="google-status" class="ms-2"></span>
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="google-key" 
                                                   placeholder="AIxxxxxxxxxxxxxxxx">
                                            <button class="btn btn-outline-secondary" type="button" 
                                                    onclick="togglePassword('google-key')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">
                                            ‰ªé <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a> Ëé∑Âèñ
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="openai-key" class="form-label">
                                            OpenAI API Key
                                            <span id="openai-status" class="ms-2"></span>
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="openai-key" 
                                                   placeholder="sk-xxxxxxxxxxxxxxxx">
                                            <button class="btn btn-outline-secondary" type="button" 
                                                    onclick="togglePassword('openai-key')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">
                                            ‰ªé <a href="https://platform.openai.com/api-keys" target="_blank">OpenAIÂπ≥Âè∞</a> Ëé∑Âèñ
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-success mb-3">üìä Êï∞ÊçÆÊ∫êAPI</h6>
                                    
                                    <div class="mb-3">
                                        <label for="finnhub-key" class="form-label">
                                            FinnHub API Key
                                            <span id="finnhub-status" class="ms-2"></span>
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="finnhub-key" 
                                                   placeholder="xxxxxxxxxxxxxxxx">
                                            <button class="btn btn-outline-secondary" type="button" 
                                                    onclick="togglePassword('finnhub-key')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">
                                            ‰ªé <a href="https://finnhub.io/" target="_blank">FinnHub</a> Ëé∑ÂèñÔºåÁî®‰∫éÁæéËÇ°Êï∞ÊçÆ
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="tushare-token" class="form-label">
                                            Tushare Token
                                            <span id="tushare-status" class="ms-2"></span>
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="tushare-token" 
                                                   placeholder="xxxxxxxxxxxxxxxx">
                                            <button class="btn btn-outline-secondary" type="button" 
                                                    onclick="togglePassword('tushare-token')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">
                                            ‰ªé <a href="https://tushare.pro/" target="_blank">Tushare Pro</a> Ëé∑ÂèñÔºåÁî®‰∫éAËÇ°Êï∞ÊçÆ
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-outline-secondary" onclick="testAllAPIs()">
                                    <i class="fas fa-vial me-2"></i>
                                    ÊµãËØïÊâÄÊúâAPI
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>
                                    ‰øùÂ≠òÈÖçÁΩÆ
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Ê®°ÂûãËÆæÁΩÆÈÄâÈ°πÂç° -->
            <div class="tab-pane fade" id="model-settings" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <i class="fas fa-robot me-2"></i>
                        AIÊ®°ÂûãÈÖçÁΩÆ
                    </div>
                    <div class="card-body">
                        <form id="model-settings-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="default-provider" class="form-label">ÈªòËÆ§AIÊèê‰æõÂïÜ</label>
                                        <select class="form-select" id="default-provider">
                                            <option value="dashscope">ÈòøÈáåÁôæÁÇº (Êé®Ëçê)</option>
                                            <option value="deepseek">DeepSeek V3</option>
                                            <option value="google">Google AI</option>
                                            <option value="openai">OpenAI</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="deep-think-model" class="form-label">Ê∑±Â∫¶ÊÄùËÄÉÊ®°Âûã</label>
                                        <select class="form-select" id="deep-think-model">
                                            <option value="qwen-plus">qwen-plus (Âπ≥Ë°°)</option>
                                            <option value="qwen-max">qwen-max (ÊúÄÂº∫)</option>
                                            <option value="qwen-turbo">qwen-turbo (Âø´ÈÄü)</option>
                                        </select>
                                        <div class="form-text">Áî®‰∫éÂ§çÊùÇÂàÜÊûêÂíåÊé®ÁêÜ‰ªªÂä°</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="quick-think-model" class="form-label">Âø´ÈÄüÊÄùËÄÉÊ®°Âûã</label>
                                        <select class="form-select" id="quick-think-model">
                                            <option value="qwen-turbo">qwen-turbo (Âø´ÈÄü)</option>
                                            <option value="qwen-plus">qwen-plus (Âπ≥Ë°°)</option>
                                        </select>
                                        <div class="form-text">Áî®‰∫éÁÆÄÂçï‰ªªÂä°ÂíåÂø´ÈÄüÂìçÂ∫î</div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="temperature" class="form-label">
                                            Temperature (ÂàõÈÄ†ÊÄß): <span id="temperature-value">0.7</span>
                                        </label>
                                        <input type="range" class="form-range" id="temperature" 
                                               min="0" max="2" step="0.1" value="0.7" 
                                               oninput="updateRangeValue('temperature')">
                                        <div class="form-text">ÊéßÂà∂ËæìÂá∫ÁöÑÈöèÊú∫ÊÄßÔºåÂÄºË∂äÈ´òË∂äÊúâÂàõÈÄ†ÊÄß</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="max-tokens" class="form-label">ÊúÄÂ§ßTokenÊï∞</label>
                                        <input type="number" class="form-control" id="max-tokens" 
                                               min="100" max="8000" value="2000">
                                        <div class="form-text">ÊéßÂà∂ËæìÂá∫ÁöÑÊúÄÂ§ßÈïøÂ∫¶</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="top-p" class="form-label">
                                            Top P (Â§öÊ†∑ÊÄß): <span id="top-p-value">0.9</span>
                                        </label>
                                        <input type="range" class="form-range" id="top-p" 
                                               min="0" max="1" step="0.1" value="0.9" 
                                               oninput="updateRangeValue('top-p')">
                                        <div class="form-text">ÊéßÂà∂ËæìÂá∫ÁöÑÂ§öÊ†∑ÊÄß</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-outline-secondary" onclick="resetModelSettings()">
                                    <i class="fas fa-undo me-2"></i>
                                    ÈáçÁΩÆÈªòËÆ§
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>
                                    ‰øùÂ≠òËÆæÁΩÆ
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Á≥ªÁªü‰ø°ÊÅØÈÄâÈ°πÂç° -->
            <div class="tab-pane fade" id="system-settings" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <i class="fas fa-server me-2"></i>
                        Á≥ªÁªü‰ø°ÊÅØ
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>üìã Âü∫Êú¨‰ø°ÊÅØ</h6>
                                <table class="table table-sm">
                                    <tr><td>Â∫îÁî®ÁâàÊú¨:</td><td><span class="badge bg-primary">v0.1.10</span></td></tr>
                                    <tr><td>Ê°ÜÊû∂ÁâàÊú¨:</td><td>Flask + Bootstrap 5</td></tr>
                                    <tr><td>PythonÁâàÊú¨:</td><td id="python-version">Ê£ÄÊü•‰∏≠...</td></tr>
                                    <tr><td>ÂêØÂä®Êó∂Èó¥:</td><td id="start-time">Ê£ÄÊü•‰∏≠...</td></tr>
                                </table>
                            </div>
                            
                            <div class="col-md-6">
                                <h6>üîß Á≥ªÁªüÁä∂ÊÄÅ</h6>
                                <table class="table table-sm">
                                    <tr><td>TradingAgentsÊ†∏ÂøÉ:</td><td id="core-status">Ê£ÄÊü•‰∏≠...</td></tr>
                                    <tr><td>Êï∞ÊçÆÂ∫ìËøûÊé•:</td><td id="db-status">Ê£ÄÊü•‰∏≠...</td></tr>
                                    <tr><td>ÁºìÂ≠òÁä∂ÊÄÅ:</td><td id="cache-status">Ê£ÄÊü•‰∏≠...</td></tr>
                                    <tr><td>APIËøûÈÄöÊÄß:</td><td id="api-connectivity">Ê£ÄÊü•‰∏≠...</td></tr>
                                </table>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div class="row">
                            <div class="col-12">
                                <h6>üßπ Á≥ªÁªüÁª¥Êä§</h6>
                                <div class="d-grid gap-2 d-md-flex">
                                    <button class="btn btn-outline-warning" onclick="clearCache()">
                                        <i class="fas fa-broom me-2"></i>
                                        Ê∏ÖÁêÜÁºìÂ≠ò
                                    </button>
                                    <button class="btn btn-outline-info" onclick="checkSystemHealth()">
                                        <i class="fas fa-heartbeat me-2"></i>
                                        Á≥ªÁªüÂÅ•Â∫∑Ê£ÄÊü•
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="exportLogs()">
                                        <i class="fas fa-file-export me-2"></i>
                                        ÂØºÂá∫Êó•Âøó
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // È°µÈù¢Âä†ËΩΩÊó∂Ëé∑ÂèñËÆæÁΩÆÊï∞ÊçÆ
    document.addEventListener('DOMContentLoaded', function() {
        loadSettings();
        loadSystemInfo();
    });
    
    function loadSettings() {
        fetch('/api/settings')
            .then(response => response.json())
            .then(data => {
                updateAPIStatus(data.api_keys);
                updateModelSettings(data.default_model);
            })
            .catch(error => {
                console.error('Âä†ËΩΩËÆæÁΩÆÂ§±Ë¥•:', error);
            });
    }
    
    function updateAPIStatus(apiKeys) {
        const statusElements = {
            'dashscope': 'dashscope-status',
            'deepseek': 'deepseek-status',
            'google': 'google-status',
            'openai': 'openai-status',
            'finnhub': 'finnhub-status',
            'tushare': 'tushare-status'
        };
        
        for (const [api, elementId] of Object.entries(statusElements)) {
            const element = document.getElementById(elementId);
            if (apiKeys[api]) {
                element.innerHTML = '<span class="badge bg-success">Â∑≤ÈÖçÁΩÆ</span>';
            } else {
                element.innerHTML = '<span class="badge bg-danger">Êú™ÈÖçÁΩÆ</span>';
            }
        }
    }
    
    function updateModelSettings(modelConfig) {
        document.getElementById('default-provider').value = modelConfig.provider;
        document.getElementById('deep-think-model').value = modelConfig.deep_think_model;
        document.getElementById('quick-think-model').value = modelConfig.quick_think_model;
    }
    
    function loadSystemInfo() {
        fetch('/api/system-status')
            .then(response => response.json())
            .then(data => {
                document.getElementById('python-version').textContent = 'Python 3.10+';
                document.getElementById('start-time').textContent = new Date().toLocaleString();
                document.getElementById('core-status').innerHTML = 
                    data.tradingagents_available ? 
                    '<span class="badge bg-success">Ê≠£Â∏∏</span>' : 
                    '<span class="badge bg-danger">ÂºÇÂ∏∏</span>';
                document.getElementById('db-status').innerHTML = '<span class="badge bg-success">Ê≠£Â∏∏</span>';
                document.getElementById('cache-status').innerHTML = '<span class="badge bg-success">Ê≠£Â∏∏</span>';
                
                const configuredKeys = Object.values(data.api_keys).filter(Boolean).length;
                const totalKeys = Object.keys(data.api_keys).length;
                document.getElementById('api-connectivity').innerHTML = 
                    `<span class="badge bg-info">${configuredKeys}/${totalKeys} ÂèØÁî®</span>`;
            })
            .catch(error => {
                console.error('Âä†ËΩΩÁ≥ªÁªü‰ø°ÊÅØÂ§±Ë¥•:', error);
            });
    }
    
    // APIËÆæÁΩÆË°®ÂçïÊèê‰∫§
    document.getElementById('api-settings-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            api_keys: {
                dashscope: document.getElementById('dashscope-key').value,
                deepseek: document.getElementById('deepseek-key').value,
                google: document.getElementById('google-key').value,
                openai: document.getElementById('openai-key').value,
                finnhub: document.getElementById('finnhub-key').value,
                tushare: document.getElementById('tushare-token').value
            }
        };
        
        fetch('/api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            showAlert('APIÈÖçÁΩÆ‰øùÂ≠òÊàêÂäü', 'success');
        })
        .catch(error => {
            showAlert('‰øùÂ≠òÂ§±Ë¥•: ' + error.message, 'danger');
        });
    });
    
    // Ê®°ÂûãËÆæÁΩÆË°®ÂçïÊèê‰∫§
    document.getElementById('model-settings-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            model_config: {
                provider: document.getElementById('default-provider').value,
                deep_think_model: document.getElementById('deep-think-model').value,
                quick_think_model: document.getElementById('quick-think-model').value,
                temperature: parseFloat(document.getElementById('temperature').value),
                max_tokens: parseInt(document.getElementById('max-tokens').value),
                top_p: parseFloat(document.getElementById('top-p').value)
            }
        };
        
        fetch('/api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            showAlert('Ê®°ÂûãËÆæÁΩÆ‰øùÂ≠òÊàêÂäü', 'success');
        })
        .catch(error => {
            showAlert('‰øùÂ≠òÂ§±Ë¥•: ' + error.message, 'danger');
        });
    });
    
    function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const button = input.nextElementSibling;
        const icon = button.querySelector('i');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.className = 'fas fa-eye-slash';
        } else {
            input.type = 'password';
            icon.className = 'fas fa-eye';
        }
    }
    
    function updateRangeValue(rangeId) {
        const range = document.getElementById(rangeId);
        const valueSpan = document.getElementById(rangeId + '-value');
        valueSpan.textContent = range.value;
    }
    
    function testAllAPIs() {
        showAlert('APIÊµãËØïÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠...', 'info');
    }
    
    function resetModelSettings() {
        document.getElementById('default-provider').value = 'dashscope';
        document.getElementById('deep-think-model').value = 'qwen-plus';
        document.getElementById('quick-think-model').value = 'qwen-turbo';
        document.getElementById('temperature').value = '0.7';
        document.getElementById('max-tokens').value = '2000';
        document.getElementById('top-p').value = '0.9';
        
        updateRangeValue('temperature');
        updateRangeValue('top-p');
    }
    
    function clearCache() {
        if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁêÜÁ≥ªÁªüÁºìÂ≠òÂêóÔºü')) {
            showAlert('ÁºìÂ≠òÊ∏ÖÁêÜÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠...', 'info');
        }
    }
    
    function checkSystemHealth() {
        showAlert('Ê≠£Âú®ËøõË°åÁ≥ªÁªüÂÅ•Â∫∑Ê£ÄÊü•...', 'info');
        // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÂÆûÈôÖÁöÑÂÅ•Â∫∑Ê£ÄÊü•ÈÄªËæë
    }
    
    function exportLogs() {
        showAlert('Êó•ÂøóÂØºÂá∫ÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠...', 'info');
    }
    
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // ÊèíÂÖ•Âà∞È°µÈù¢È°∂ÈÉ®
        const container = document.querySelector('.container');
        container.insertBefore(alertDiv, container.firstChild);
        
        // 3ÁßíÂêéËá™Âä®Ê∂àÂ§±
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 3000);
    }
</script>
{% endblock %}