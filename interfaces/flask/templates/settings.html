{% extends "base.html" %}

{% block title %}ç³»ç»Ÿè®¾ç½® - TradingAgents-CN{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-cog me-2"></i>
            ç³»ç»Ÿè®¾ç½®
        </h1>
    </div>
</div>

<!-- è®¾ç½®é€‰é¡¹å¡ -->
<div class="row">
    <div class="col-12">
        <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="api-tab" data-bs-toggle="tab" 
                        data-bs-target="#api-settings" type="button" role="tab">
                    <i class="fas fa-key me-2"></i>
                    APIé…ç½®
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="model-tab" data-bs-toggle="tab" 
                        data-bs-target="#model-settings" type="button" role="tab">
                    <i class="fas fa-robot me-2"></i>
                    æ¨¡å‹è®¾ç½®
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="system-tab" data-bs-toggle="tab" 
                        data-bs-target="#system-settings" type="button" role="tab">
                    <i class="fas fa-server me-2"></i>
                    ç³»ç»Ÿä¿¡æ¯
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="settingsTabContent">
            <!-- APIé…ç½®é€‰é¡¹å¡ -->
            <div class="tab-pane fade show active" id="api-settings" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <i class="fas fa-key me-2"></i>
                        APIå¯†é’¥é…ç½®
                    </div>
                    <div class="card-body">
                        <form id="api-settings-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary mb-3">ğŸ‡¨ğŸ‡³ å›½äº§AIæ¨¡å‹</h6>
                                    
                                    <div class="mb-3">
                                        <label for="dashscope-key" class="form-label">
                                            é˜¿é‡Œç™¾ç‚¼ API Key
                                            <span id="dashscope-status" class="ms-2"></span>
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="dashscope-key" 
                                                   placeholder="sk-xxxxxxxxxxxxxxxx">
                                            <button class="btn btn-outline-secondary" type="button" 
                                                    onclick="togglePassword('dashscope-key')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">
                                            ä» <a href="https://dashscope.aliyun.com/" target="_blank">é˜¿é‡Œç™¾ç‚¼æ§åˆ¶å°</a> è·å–
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="deepseek-key" class="form-label">
                                            DeepSeek API Key
                                            <span id="deepseek-status" class="ms-2"></span>
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="deepseek-key" 
                                                   placeholder="sk-xxxxxxxxxxxxxxxx">
                                            <button class="btn btn-outline-secondary" type="button" 
                                                    onclick="togglePassword('deepseek-key')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">
                                            ä» <a href="https://platform.deepseek.com/" target="_blank">DeepSeekå¹³å°</a> è·å–
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6 class="text-info mb-3">ğŸŒ å›½é™…AIæ¨¡å‹</h6>
                                    
                                    <div class="mb-3">
                                        <label for="google-key" class="form-label">
                                            Google AI API Key
                                            <span id="google-status" class="ms-2"></span>
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="google-key" 
                                                   placeholder="AIxxxxxxxxxxxxxxxx">
                                            <button class="btn btn-outline-secondary" type="button" 
                                                    onclick="togglePassword('google-key')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">
                                            ä» <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a> è·å–
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="openai-key" class="form-label">
                                            OpenAI API Key
                                            <span id="openai-status" class="ms-2"></span>
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="openai-key" 
                                                   placeholder="sk-xxxxxxxxxxxxxxxx">
                                            <button class="btn btn-outline-secondary" type="button" 
                                                    onclick="togglePassword('openai-key')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">
                                            ä» <a href="https://platform.openai.com/api-keys" target="_blank">OpenAIå¹³å°</a> è·å–
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-success mb-3">ğŸ“Š æ•°æ®æºAPI</h6>
                                    
                                    <div class="mb-3">
                                        <label for="finnhub-key" class="form-label">
                                            FinnHub API Key
                                            <span id="finnhub-status" class="ms-2"></span>
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="finnhub-key" 
                                                   placeholder="xxxxxxxxxxxxxxxx">
                                            <button class="btn btn-outline-secondary" type="button" 
                                                    onclick="togglePassword('finnhub-key')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">
                                            ä» <a href="https://finnhub.io/" target="_blank">FinnHub</a> è·å–ï¼Œç”¨äºç¾è‚¡æ•°æ®
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="tushare-token" class="form-label">
                                            Tushare Token
                                            <span id="tushare-status" class="ms-2"></span>
                                        </label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="tushare-token" 
                                                   placeholder="xxxxxxxxxxxxxxxx">
                                            <button class="btn btn-outline-secondary" type="button" 
                                                    onclick="togglePassword('tushare-token')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">
                                            ä» <a href="https://tushare.pro/" target="_blank">Tushare Pro</a> è·å–ï¼Œç”¨äºAè‚¡æ•°æ®
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-outline-secondary" onclick="testAllAPIs()">
                                    <i class="fas fa-vial me-2"></i>
                                    æµ‹è¯•æ‰€æœ‰API
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>
                                    ä¿å­˜é…ç½®
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- æ¨¡å‹è®¾ç½®é€‰é¡¹å¡ -->
            <div class="tab-pane fade" id="model-settings" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <i class="fas fa-robot me-2"></i>
                        AIæ¨¡å‹é…ç½®
                    </div>
                    <div class="card-body">
                        <form id="model-settings-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="default-provider" class="form-label">é»˜è®¤AIæä¾›å•†</label>
                                        <select class="form-select" id="default-provider">
                                            <option value="dashscope">é˜¿é‡Œç™¾ç‚¼ (æ¨è)</option>
                                            <option value="deepseek">DeepSeek V3</option>
                                            <option value="google">Google AI</option>
                                            <option value="openai">OpenAI</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="deep-think-model" class="form-label">æ·±åº¦æ€è€ƒæ¨¡å‹</label>
                                        <select class="form-select" id="deep-think-model">
                                            <option value="qwen-plus">qwen-plus (å¹³è¡¡)</option>
                                            <option value="qwen-max">qwen-max (æœ€å¼º)</option>
                                            <option value="qwen-turbo">qwen-turbo (å¿«é€Ÿ)</option>
                                        </select>
                                        <div class="form-text">ç”¨äºå¤æ‚åˆ†æå’Œæ¨ç†ä»»åŠ¡</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="quick-think-model" class="form-label">å¿«é€Ÿæ€è€ƒæ¨¡å‹</label>
                                        <select class="form-select" id="quick-think-model">
                                            <option value="qwen-turbo">qwen-turbo (å¿«é€Ÿ)</option>
                                            <option value="qwen-plus">qwen-plus (å¹³è¡¡)</option>
                                        </select>
                                        <div class="form-text">ç”¨äºç®€å•ä»»åŠ¡å’Œå¿«é€Ÿå“åº”</div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="temperature" class="form-label">
                                            Temperature (åˆ›é€ æ€§): <span id="temperature-value">0.7</span>
                                        </label>
                                        <input type="range" class="form-range" id="temperature" 
                                               min="0" max="2" step="0.1" value="0.7" 
                                               oninput="updateRangeValue('temperature')">
                                        <div class="form-text">æ§åˆ¶è¾“å‡ºçš„éšæœºæ€§ï¼Œå€¼è¶Šé«˜è¶Šæœ‰åˆ›é€ æ€§</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="max-tokens" class="form-label">æœ€å¤§Tokenæ•°</label>
                                        <input type="number" class="form-control" id="max-tokens" 
                                               min="100" max="8000" value="2000">
                                        <div class="form-text">æ§åˆ¶è¾“å‡ºçš„æœ€å¤§é•¿åº¦</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="top-p" class="form-label">
                                            Top P (å¤šæ ·æ€§): <span id="top-p-value">0.9</span>
                                        </label>
                                        <input type="range" class="form-range" id="top-p" 
                                               min="0" max="1" step="0.1" value="0.9" 
                                               oninput="updateRangeValue('top-p')">
                                        <div class="form-text">æ§åˆ¶è¾“å‡ºçš„å¤šæ ·æ€§</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-outline-secondary" onclick="resetModelSettings()">
                                    <i class="fas fa-undo me-2"></i>
                                    é‡ç½®é»˜è®¤
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>
                                    ä¿å­˜è®¾ç½®
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- ç³»ç»Ÿä¿¡æ¯é€‰é¡¹å¡ -->
            <div class="tab-pane fade" id="system-settings" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <i class="fas fa-server me-2"></i>
                        ç³»ç»Ÿä¿¡æ¯
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h6>
                                <table class="table table-sm">
                                    <tr><td>åº”ç”¨ç‰ˆæœ¬:</td><td><span class="badge bg-primary">v0.1.10</span></td></tr>
                                    <tr><td>æ¡†æ¶ç‰ˆæœ¬:</td><td>Flask + Bootstrap 5</td></tr>
                                    <tr><td>Pythonç‰ˆæœ¬:</td><td id="python-version">æ£€æŸ¥ä¸­...</td></tr>
                                    <tr><td>å¯åŠ¨æ—¶é—´:</td><td id="start-time">æ£€æŸ¥ä¸­...</td></tr>
                                </table>
                            </div>
                            
                            <div class="col-md-6">
                                <h6>ğŸ”§ ç³»ç»ŸçŠ¶æ€</h6>
                                <table class="table table-sm">
                                    <tr><td>TradingAgentsæ ¸å¿ƒ:</td><td id="core-status">æ£€æŸ¥ä¸­...</td></tr>
                                    <tr><td>æ•°æ®åº“è¿æ¥:</td><td id="db-status">æ£€æŸ¥ä¸­...</td></tr>
                                    <tr><td>ç¼“å­˜çŠ¶æ€:</td><td id="cache-status">æ£€æŸ¥ä¸­...</td></tr>
                                    <tr><td>APIè¿é€šæ€§:</td><td id="api-connectivity">æ£€æŸ¥ä¸­...</td></tr>
                                </table>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div class="row">
                            <div class="col-12">
                                <h6>ğŸ§¹ ç³»ç»Ÿç»´æŠ¤</h6>
                                <div class="d-grid gap-2 d-md-flex">
                                    <button class="btn btn-outline-warning" onclick="clearCache()">
                                        <i class="fas fa-broom me-2"></i>
                                        æ¸…ç†ç¼“å­˜
                                    </button>
                                    <button class="btn btn-outline-info" onclick="checkSystemHealth()">
                                        <i class="fas fa-heartbeat me-2"></i>
                                        ç³»ç»Ÿå¥åº·æ£€æŸ¥
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="exportLogs()">
                                        <i class="fas fa-file-export me-2"></i>
                                        å¯¼å‡ºæ—¥å¿—
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // é¡µé¢åŠ è½½æ—¶è·å–è®¾ç½®æ•°æ®
    document.addEventListener('DOMContentLoaded', function() {
        loadSettings();
        loadSystemInfo();
    });
    
    function loadSettings() {
        fetch('/api/settings')
            .then(response => response.json())
            .then(data => {
                updateAPIStatus(data.api_keys);
                updateModelSettings(data.default_model);
            })
            .catch(error => {
                console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
            });
    }
    
    function updateAPIStatus(apiKeys) {
        const statusElements = {
            'dashscope': 'dashscope-status',
            'deepseek': 'deepseek-status',
            'google': 'google-status',
            'openai': 'openai-status',
            'finnhub': 'finnhub-status',
            'tushare': 'tushare-status'
        };
        
        for (const [api, elementId] of Object.entries(statusElements)) {
            const element = document.getElementById(elementId);
            if (apiKeys[api]) {
                element.innerHTML = '<span class="badge bg-success">å·²é…ç½®</span>';
            } else {
                element.innerHTML = '<span class="badge bg-danger">æœªé…ç½®</span>';
            }
        }
    }
    
    function updateModelSettings(modelConfig) {
        document.getElementById('default-provider').value = modelConfig.provider;
        document.getElementById('deep-think-model').value = modelConfig.deep_think_model;
        document.getElementById('quick-think-model').value = modelConfig.quick_think_model;
    }
    
    function loadSystemInfo() {
        fetch('/api/system-status')
            .then(response => response.json())
            .then(data => {
                document.getElementById('python-version').textContent = 'Python 3.10+';
                document.getElementById('start-time').textContent = new Date().toLocaleString();
                document.getElementById('core-status').innerHTML = 
                    data.tradingagents_available ? 
                    '<span class="badge bg-success">æ­£å¸¸</span>' : 
                    '<span class="badge bg-danger">å¼‚å¸¸</span>';
                document.getElementById('db-status').innerHTML = '<span class="badge bg-success">æ­£å¸¸</span>';
                document.getElementById('cache-status').innerHTML = '<span class="badge bg-success">æ­£å¸¸</span>';
                
                const configuredKeys = Object.values(data.api_keys).filter(Boolean).length;
                const totalKeys = Object.keys(data.api_keys).length;
                document.getElementById('api-connectivity').innerHTML = 
                    `<span class="badge bg-info">${configuredKeys}/${totalKeys} å¯ç”¨</span>`;
            })
            .catch(error => {
                console.error('åŠ è½½ç³»ç»Ÿä¿¡æ¯å¤±è´¥:', error);
            });
    }
    
    // APIè®¾ç½®è¡¨å•æäº¤
    document.getElementById('api-settings-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            api_keys: {
                dashscope: document.getElementById('dashscope-key').value,
                deepseek: document.getElementById('deepseek-key').value,
                google: document.getElementById('google-key').value,
                openai: document.getElementById('openai-key').value,
                finnhub: document.getElementById('finnhub-key').value,
                tushare: document.getElementById('tushare-token').value
            }
        };
        
        fetch('/api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            showAlert('APIé…ç½®ä¿å­˜æˆåŠŸ', 'success');
        })
        .catch(error => {
            showAlert('ä¿å­˜å¤±è´¥: ' + error.message, 'danger');
        });
    });
    
    // æ¨¡å‹è®¾ç½®è¡¨å•æäº¤
    document.getElementById('model-settings-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            model_config: {
                provider: document.getElementById('default-provider').value,
                deep_think_model: document.getElementById('deep-think-model').value,
                quick_think_model: document.getElementById('quick-think-model').value,
                temperature: parseFloat(document.getElementById('temperature').value),
                max_tokens: parseInt(document.getElementById('max-tokens').value),
                top_p: parseFloat(document.getElementById('top-p').value)
            }
        };
        
        fetch('/api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            showAlert('æ¨¡å‹è®¾ç½®ä¿å­˜æˆåŠŸ', 'success');
        })
        .catch(error => {
            showAlert('ä¿å­˜å¤±è´¥: ' + error.message, 'danger');
        });
    });
    
    function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const button = input.nextElementSibling;
        const icon = button.querySelector('i');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.className = 'fas fa-eye-slash';
        } else {
            input.type = 'password';
            icon.className = 'fas fa-eye';
        }
    }
    
    function updateRangeValue(rangeId) {
        const range = document.getElementById(rangeId);
        const valueSpan = document.getElementById(rangeId + '-value');
        valueSpan.textContent = range.value;
    }
    
    function testAllAPIs() {
        showAlert('APIæµ‹è¯•åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...', 'info');
    }
    
    function resetModelSettings() {
        document.getElementById('default-provider').value = 'dashscope';
        document.getElementById('deep-think-model').value = 'qwen-plus';
        document.getElementById('quick-think-model').value = 'qwen-turbo';
        document.getElementById('temperature').value = '0.7';
        document.getElementById('max-tokens').value = '2000';
        document.getElementById('top-p').value = '0.9';
        
        updateRangeValue('temperature');
        updateRangeValue('top-p');
    }
    
    function clearCache() {
        if (confirm('ç¡®å®šè¦æ¸…ç†ç³»ç»Ÿç¼“å­˜å—ï¼Ÿ')) {
            showAlert('ç¼“å­˜æ¸…ç†åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...', 'info');
        }
    }
    
    function checkSystemHealth() {
        showAlert('æ­£åœ¨è¿›è¡Œç³»ç»Ÿå¥åº·æ£€æŸ¥...', 'info');
        // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„å¥åº·æ£€æŸ¥é€»è¾‘
    }
    
    function exportLogs() {
        showAlert('æ—¥å¿—å¯¼å‡ºåŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...', 'info');
    }
    
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // æ’å…¥åˆ°é¡µé¢é¡¶éƒ¨
        const container = document.querySelector('.container');
        container.insertBefore(alertDiv, container.firstChild);
        
        // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 3000);
    }
</script>
{% endblock %}